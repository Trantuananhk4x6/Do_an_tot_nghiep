@startuml sequence-diagram-review
!theme plain
skinparam backgroundColor #FEFEFE
skinparam ParticipantBackgroundColor #E3F2FD
skinparam ParticipantBorderColor #1565C0
skinparam SequenceGroupBackgroundColor #F3E5F5
skinparam NoteBackgroundColor #FFFDE7
skinparam NoteBorderColor #F9A825

title Sequence Diagram - UC009: ÄÃ¡nh giÃ¡ vÃ  nháº­n xÃ©t há»‡ thá»‘ng (Reviews)

actor "NgÆ°á»i dÃ¹ng" as User
participant "Reviews Page\n(page.tsx)" as ReviewsPage
participant "Clerk\n(useUser)" as Clerk
participant "API\n(/api/ratings)" as API
database "Database\n(Rating Table)" as DB

== Táº£i trang vÃ  Load Ä‘Ã¡nh giÃ¡ ==

User -> ReviewsPage: Truy cáº­p /reviews
activate ReviewsPage

ReviewsPage -> Clerk: useUser()
activate Clerk
Clerk --> ReviewsPage: { user, isSignedIn }
deactivate Clerk

ReviewsPage -> API: GET /api/ratings
activate API
API -> DB: SELECT * FROM Rating\nORDER BY createdAt DESC
activate DB
DB --> API: ratings[]
deactivate DB

API -> API: TÃ­nh averageRating = sum/count
API -> API: TÃ­nh totalRatings = length

API --> ReviewsPage: { ratings, averageRating, totalRatings }
deactivate API

ReviewsPage -> ReviewsPage: setAllRatings(ratings)
ReviewsPage -> ReviewsPage: setAverageRating(averageRating)
ReviewsPage -> ReviewsPage: setTotalRatings(totalRatings)
ReviewsPage -> ReviewsPage: TÃ­nh ratingDistribution [5,4,3,2,1]

ReviewsPage --> User: Hiá»ƒn thá»‹ trang vá»›i:\n- Thá»‘ng kÃª (Ä‘iá»ƒm TB, biá»ƒu Ä‘á»“ phÃ¢n bá»‘)\n- Danh sÃ¡ch Ä‘Ã¡nh giÃ¡\n- Form gá»­i Ä‘Ã¡nh giÃ¡

== Kiá»ƒm tra Ä‘Ã¡nh giÃ¡ cÅ© cá»§a ngÆ°á»i dÃ¹ng ==

alt NgÆ°á»i dÃ¹ng Ä‘Ã£ Ä‘Äƒng nháº­p
    ReviewsPage -> ReviewsPage: TÃ¬m Ä‘Ã¡nh giÃ¡ cá»§a user trong allRatings
    
    alt ÄÃ£ Ä‘Ã¡nh giÃ¡ trÆ°á»›c Ä‘Ã³
        ReviewsPage -> ReviewsPage: setHasUserRated(true)
        ReviewsPage -> ReviewsPage: setSelectedRating(userRating.rating)
        ReviewsPage -> ReviewsPage: setComment(userRating.comment)
        ReviewsPage --> User: Hiá»ƒn thá»‹ Ä‘Ã¡nh giÃ¡ cÅ©\nvÃ  nÃºt "Update Review"
    else ChÆ°a Ä‘Ã¡nh giÃ¡
        ReviewsPage --> User: Hiá»ƒn thá»‹ form trá»‘ng\nvÃ  nÃºt "Submit Review"
    end
else ChÆ°a Ä‘Äƒng nháº­p
    ReviewsPage --> User: Hiá»ƒn thá»‹ thÃ´ng bÃ¡o\n"Please sign in to leave a review"\nvÃ  nÃºt "Sign In"
end

== Lá»c Ä‘Ã¡nh giÃ¡ theo sá»‘ sao (TÃ¹y chá»n) ==

User -> ReviewsPage: Click vÃ o sá»‘ sao trong biá»ƒu Ä‘á»“ (vÃ­ dá»¥: 5 sao)
ReviewsPage -> ReviewsPage: setFilterRating(5)
ReviewsPage -> ReviewsPage: filteredRatings = allRatings.filter(r => r.rating === 5)
ReviewsPage --> User: Hiá»ƒn thá»‹ chá»‰ Ä‘Ã¡nh giÃ¡ 5 sao\nvÃ  nÃºt "Clear filter"

User -> ReviewsPage: Click "Clear filter"
ReviewsPage -> ReviewsPage: setFilterRating(null)
ReviewsPage --> User: Hiá»ƒn thá»‹ táº¥t cáº£ Ä‘Ã¡nh giÃ¡

== Gá»­i Ä‘Ã¡nh giÃ¡ má»›i ==

User -> ReviewsPage: Chá»n sá»‘ sao (1-5)
ReviewsPage -> ReviewsPage: setSelectedRating(selectedStar)
ReviewsPage -> ReviewsPage: setHoveredRating(hoveredStar)
ReviewsPage --> User: Highlight sao Ä‘Ã£ chá»n

User -> ReviewsPage: Nháº­p nháº­n xÃ©t (tÃ¹y chá»n)
ReviewsPage -> ReviewsPage: setComment(text)

User -> ReviewsPage: Click "Submit Review"
activate ReviewsPage

alt ChÆ°a chá»n sá»‘ sao
    ReviewsPage -> ReviewsPage: setSubmitMessage({ type: 'error',\ntext: 'Please select a rating!' })
    ReviewsPage --> User: Hiá»ƒn thá»‹ thÃ´ng bÃ¡o lá»—i
else ÄÃ£ chá»n sá»‘ sao
    ReviewsPage -> ReviewsPage: setIsSubmitting(true)
    
    ReviewsPage -> API: POST /api/ratings\n{ userEmail, userName, rating, comment }
    activate API
    
    API -> API: Validate required fields
    API -> API: Validate rating (1-5)
    
    API -> DB: SELECT * FROM Rating\nWHERE userEmail = ?
    activate DB
    DB --> API: existingRating
    deactivate DB
    
    alt ÄÃ¡nh giÃ¡ Ä‘Ã£ tá»“n táº¡i
        API -> DB: UPDATE Rating\nSET rating = ?, comment = ?, updatedAt = NOW()\nWHERE userEmail = ?
        activate DB
        DB --> API: success
        deactivate DB
        API --> ReviewsPage: { success: true, message: "Rating saved successfully" }
    else ÄÃ¡nh giÃ¡ má»›i
        API -> DB: INSERT INTO Rating\n(userEmail, userName, rating, comment)
        activate DB
        DB --> API: success
        deactivate DB
        API --> ReviewsPage: { success: true, message: "Rating saved successfully" }
    end
    deactivate API
    
    alt API thÃ nh cÃ´ng
        ReviewsPage -> ReviewsPage: setSubmitMessage({ type: 'success',\ntext: hasUserRated ?\n'Review updated!' : 'Thank you for your review! ðŸŽ‰' })
        
        ReviewsPage -> API: GET /api/ratings (reload)
        activate API
        API -> DB: SELECT * FROM Rating
        activate DB
        DB --> API: updated ratings[]
        deactivate DB
        API --> ReviewsPage: { ratings, averageRating, totalRatings }
        deactivate API
        
        ReviewsPage -> ReviewsPage: Cáº­p nháº­t state vá»›i data má»›i
        ReviewsPage -> ReviewsPage: setHasUserRated(true)
        ReviewsPage -> ReviewsPage: scrollIntoView("reviews-section")
        
        ReviewsPage --> User: Hiá»ƒn thá»‹ thÃ´ng bÃ¡o thÃ nh cÃ´ng\nvÃ  Ä‘Ã¡nh giÃ¡ má»›i trong danh sÃ¡ch
    else API tháº¥t báº¡i
        ReviewsPage -> ReviewsPage: setSubmitMessage({ type: 'error',\ntext: 'Network error...' })
        ReviewsPage --> User: Hiá»ƒn thá»‹ thÃ´ng bÃ¡o lá»—i
    end
    
    ReviewsPage -> ReviewsPage: setIsSubmitting(false)
end

deactivate ReviewsPage

@enduml
