<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Vietnamese Speech Recognition</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        h1 {
            color: #4CAF50;
        }
        .status {
            background: #2a2a2a;
            border: 2px solid #555;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        .status.listening {
            border-color: #4CAF50;
            background: #1a3a1a;
        }
        .status.error {
            border-color: #f44336;
            background: #3a1a1a;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        button:hover {
            background: #45a049;
        }
        button.stop {
            background: #f44336;
        }
        button.stop:hover {
            background: #da190b;
        }
        .transcript {
            background: #2a2a2a;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            min-height: 100px;
            font-size: 18px;
            line-height: 1.6;
        }
        .info {
            background: #2a2a3a;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .language-selector {
            margin: 20px 0;
        }
        select {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 10px;
            border-radius: 5px;
            font-size: 16px;
            margin: 0 10px;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>üé§ Test Vietnamese Speech Recognition</h1>
    
    <div class="info">
        <h3>üìã Instructions</h3>
        <ul>
            <li>Select language (Vietnamese or English)</li>
            <li>Click "Start Listening"</li>
            <li>Speak clearly into your microphone</li>
            <li>Your speech will appear in the transcript box</li>
            <li>Click "Stop" when finished</li>
        </ul>
    </div>

    <div class="language-selector">
        <label for="language">Select Language:</label>
        <select id="language">
            <option value="vi-VN" selected>üáªüá≥ Ti·∫øng Vi·ªát (vi-VN)</option>
            <option value="en-US">üá∫üá∏ English (en-US)</option>
            <option value="ja-JP">üáØüáµ Êó•Êú¨Ë™û (ja-JP)</option>
            <option value="zh-CN">üá®üá≥ ‰∏≠Êñá (zh-CN)</option>
            <option value="ko-KR">üá∞üá∑ ÌïúÍµ≠Ïñ¥ (ko-KR)</option>
        </select>
        <button onclick="startRecognition()">üé§ Start Listening</button>
        <button class="stop" onclick="stopRecognition()">‚èπÔ∏è Stop</button>
        <button onclick="clearTranscript()">üóëÔ∏è Clear</button>
    </div>

    <div class="status" id="status">
        <h2>Ready</h2>
        <p>Click "Start Listening" to begin</p>
    </div>

    <div class="transcript" id="transcript">
        <em>Transcript will appear here...</em>
    </div>

    <div class="info">
        <h3>üìä Debug Info</h3>
        <div id="debugInfo">
            Waiting for recognition to start...
        </div>
    </div>

    <div class="log" id="log">
        <strong>Console Log:</strong><br>
    </div>

    <script>
        let recognition = null;
        let isListening = false;
        let fullTranscript = '';

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f44' : type === 'success' ? '#4f4' : '#0f0';
            logDiv.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span><br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function updateStatus(title, message, className = '') {
            const status = document.getElementById('status');
            status.className = 'status ' + className;
            status.innerHTML = `<h2>${title}</h2><p>${message}</p>`;
        }

        function updateDebugInfo() {
            const debugInfo = document.getElementById('debugInfo');
            const language = document.getElementById('language').value;
            debugInfo.innerHTML = `
                <strong>Language:</strong> ${language}<br>
                <strong>Status:</strong> ${isListening ? 'üü¢ Listening' : 'üî¥ Stopped'}<br>
                <strong>Recognition Object:</strong> ${recognition ? '‚úÖ Available' : '‚ùå Not initialized'}<br>
                <strong>Browser Support:</strong> ${('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) ? '‚úÖ Supported' : '‚ùå Not supported'}
            `;
        }

        function initRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                log('‚ùå Speech Recognition not supported in this browser!', 'error');
                updateStatus('Error', 'Speech Recognition not supported', 'error');
                return false;
            }

            recognition = new SpeechRecognition();
            const language = document.getElementById('language').value;
            
            // Configure recognition
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = language;
            recognition.maxAlternatives = 1;

            log(`‚úÖ Recognition initialized with language: ${language}`, 'success');

            recognition.onstart = () => {
                isListening = true;
                log('üé§ Recognition STARTED', 'success');
                updateStatus('Listening...', 'Speak now!', 'listening');
                updateDebugInfo();
            };

            recognition.onresult = (event) => {
                log(`üìä Received result event with ${event.results.length} results`);
                
                fullTranscript = '';
                
                // Accumulate all results
                for (let i = 0; i < event.results.length; i++) {
                    const result = event.results[i];
                    const transcript = result[0].transcript;
                    const isFinal = result.isFinal;
                    
                    log(`Result ${i}: "${transcript}" (${isFinal ? 'FINAL' : 'interim'}, confidence: ${result[0].confidence || 'N/A'})`);
                    
                    fullTranscript += transcript + ' ';
                }
                
                fullTranscript = fullTranscript.trim();
                
                // Update transcript display
                const transcriptDiv = document.getElementById('transcript');
                transcriptDiv.innerHTML = fullTranscript || '<em>Listening...</em>';
                
                updateStatus('Listening...', `Captured: ${fullTranscript.length} characters`, 'listening');
            };

            recognition.onerror = (event) => {
                log(`‚ùå Recognition ERROR: ${event.error} (${event.message || 'no message'})`, 'error');
                
                if (event.error === 'no-speech') {
                    updateStatus('No speech detected', 'Try speaking louder', 'error');
                } else if (event.error === 'audio-capture') {
                    updateStatus('Microphone Error', 'Check microphone permissions', 'error');
                } else if (event.error === 'not-allowed') {
                    updateStatus('Permission Denied', 'Please allow microphone access', 'error');
                } else if (event.error !== 'aborted') {
                    updateStatus('Error', `Recognition error: ${event.error}`, 'error');
                }
                
                updateDebugInfo();
            };

            recognition.onend = () => {
                isListening = false;
                log('üõë Recognition ENDED', 'success');
                updateStatus('Stopped', 'Click "Start Listening" to resume', '');
                updateDebugInfo();
            };

            // Additional debug events
            recognition.onspeechstart = () => log('üó£Ô∏è Speech detected!', 'success');
            recognition.onspeechend = () => log('ü§ê Speech ended');
            recognition.onsoundstart = () => log('üîä Sound detected');
            recognition.onsoundend = () => log('üîá Sound ended');

            return true;
        }

        function startRecognition() {
            if (isListening) {
                log('‚ö†Ô∏è Already listening!', 'error');
                return;
            }

            if (!recognition || recognition.lang !== document.getElementById('language').value) {
                if (!initRecognition()) {
                    return;
                }
            }

            try {
                fullTranscript = '';
                document.getElementById('transcript').innerHTML = '<em>Listening...</em>';
                recognition.start();
                log('üöÄ Starting recognition...', 'success');
            } catch (error) {
                log(`‚ùå Error starting recognition: ${error.message}`, 'error');
            }
        }

        function stopRecognition() {
            if (!recognition || !isListening) {
                log('‚ö†Ô∏è Not currently listening', 'error');
                return;
            }

            try {
                recognition.stop();
                log('‚èπÔ∏è Stopping recognition...', 'success');
            } catch (error) {
                log(`‚ùå Error stopping recognition: ${error.message}`, 'error');
            }
        }

        function clearTranscript() {
            fullTranscript = '';
            document.getElementById('transcript').innerHTML = '<em>Transcript cleared...</em>';
            log('üóëÔ∏è Transcript cleared', 'success');
        }

        // Update debug info on language change
        document.getElementById('language').addEventListener('change', () => {
            recognition = null; // Force re-initialization
            updateDebugInfo();
            log('Language changed - recognition will be reinitialized on next start', 'info');
        });

        // Initial setup
        updateDebugInfo();
        log('Page loaded - ready to test', 'success');
    </script>
</body>
</html>
